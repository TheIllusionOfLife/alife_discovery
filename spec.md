# 仕様書：目的関数を持たない進化的探索による構造創発 PoC

> **ドキュメント種別**: 実装仕様書（Implementation Spec）
> **位置づけ**: 初期提案書とレビューの両方を踏まえ、研究者との対話を通じて設計判断を確定させた正式な仕様書。**実装はこのドキュメントに従うこと。**
>
> **経緯**:
> 1. [`project_onboarding_guide_objective_free_alife.md`](project_onboarding_guide_objective_free_alife.md) — 初期提案書。研究の動機・基本戦略・最小世界モデルを提示。
> 2. [`unified_review.md`](unified_review.md) — 初期提案書に対するレビュー。「破綻フィルタが暗黙の目的関数になる」等の重大な懸念を指摘。
> 3. **本ドキュメント** — レビューの指摘を受けて、研究者と設計判断を一つずつ確認し、合意した仕様をまとめたもの。
>
> **主要な設計変更（初期提案からの差分）**:
> - フィルタを物理的不整合のみ（全停止＋状態単一化）に限定し、「目的関数なし」を厳守
> - 停滞・短周期ループ・再現性フィルタを除外
> - 重なり禁止＋移動失敗ルールを明確化
> - 観測空間を簡素化（近傍の個体数のみ、内部状態は観測しない）
> - ランダム逐次更新を採用
> - 全指標の計算式を定義
> - データ保存形式をJSON + Parquetに決定

---

## 1. 研究方針

- **コアクレーム**: 目的関数なしを厳密に貫く。フィルタは物理的不整合の排除のみ。
- **アウトプット**: 探索的PoC。動くものを作り、結果を見てから論文化を判断。
- **開発手法**: TDDで堅実に進める。

---

## 2. 世界モデル

| パラメータ | 値 | 備考 |
|-----------|-----|------|
| グリッドサイズ | 20×20 | トーラス（上下左右がループ） |
| エージェント数 | 30 | 固定 |
| 内部状態 | 0〜3（4値） | 各エージェントが保持 |
| シミュレーション長 | 200ステップ（デフォルト） | パラメータとして可変 |

### 2.1 衝突ルール

- **重なり禁止**: 同一セルに複数エージェントは存在できない。
- **移動失敗**: 移動先に他エージェントがいる場合、移動は失敗しその場に留まる。

### 2.2 更新順序

- **ランダム逐次更新**: 毎ステップ、エージェントをランダムな順序でシャッフルし、1体ずつ行動を実行する。
- 逐次更新のため、先に行動したエージェントの結果が後のエージェントの観測に影響する。

---

## 3. 観測空間

各エージェントが行動を決定するための入力:

| 入力 | 値域 | 説明 |
|------|------|------|
| 自身の内部状態 | 0〜3（4値） | |
| 上セルの個体数 | 0 or 1（2値） | 重なり禁止なので0か1 |
| 下セルの個体数 | 0 or 1（2値） | |
| 左セルの個体数 | 0 or 1（2値） | |
| 右セルの個体数 | 0 or 1（2値） | |
| 自セルの個体数 | 0 or 1（2値） | 常に1（自分がいる）だが形式上含む |

**入力空間サイズ**: 4 × 2^5 = 128 エントリ

> 注: 近傍エージェントの内部状態は観測しない。個体の存在有無のみ。

---

## 4. 行動空間

行動は排他的（各ステップで1つだけ選択）:

| 行動ID | 行動 | 説明 |
|--------|------|------|
| 0 | 上に移動 | |
| 1 | 下に移動 | |
| 2 | 左に移動 | |
| 3 | 右に移動 | |
| 4 | 状態を0に変更 | |
| 5 | 状態を1に変更 | |
| 6 | 状態を2に変更 | |
| 7 | 状態を3に変更 | |
| 8 | 何もしない | |

**行動空間サイズ**: 9

---

## 5. ルールテーブル

- **形式**: 128エントリのルックアップテーブル。各エントリは行動ID（0〜8）。
- **生成方法**: 各エントリをランダムに0〜8から一様に選択。
- **ルール空間**: 9^128 ≈ 10^122（膨大だがランダムサンプリングで探索）。
- **全エージェント共有**: 同一シミュレーション内の全エージェントは同一ルールテーブルを使用。

---

## 6. 破綻フィルタ（物理的不整合のみ）

「目的関数なし」の原則を厳守し、以下の物理的不整合のみを排除する。

### 6.1 全停止検出（連続停止）

- **条件**: Nステップ連続で、全エージェントの位置・内部状態に変化がない場合、破綻とみなす。
- **N**: パラメータ化する（デフォルト値は実験で決定）。
- **早期打ち切り**: 検出された時点でシミュレーションを中断し、計算コストを節約。

### 6.2 状態単一化検出

- **条件**: 全30エージェントの内部状態が完全に同一になった場合、破綻とみなす。
- **判定方法**: 完全同一のみ（閾値やエントロピーは使わない）。
- **正当化**: 区別不能な系は定義上観測不可能であり、情報理論的に意味を持たない。

### 除外した項目（目的関数化のリスクがあるため）

- ~~位置の単一化~~ → 重なり禁止なので物理的に発生しない
- ~~短周期ループ~~ → 動的複雑性を暗黙に要求してしまう
- ~~低活動（停滞）~~ → 活動量への選好が入ってしまう
- ~~再現性なし（強フィルタ）~~ → プロトコル未定義のため後回し

---

## 7. 観測指標（フルセット）

選別には一切使用しない。シミュレーション後の分析専用。

### 7.1 非自明さ

| 指標 | 計算方法 |
|------|---------|
| 状態エントロピー | Shannon entropy: H = -Σ p(s) log2 p(s)。全エージェントの内部状態分布から各ステップで計算。 |
| 圧縮率 | zlib圧縮後のサイズ / 元サイズ。グリッド全体の状態をバイト列にシリアライズして計算。 |
| 予測可能性 | t時点の状態からt+1の状態をどの程度予測できるか。自己相互情報量 I(S_t; S_{t+1}) で測定。 |

### 7.2 空間構造

| 指標 | 計算方法 |
|------|---------|
| 空間自己相関 | Moran's I。重み行列はトーラス上の隣接セル（4近傍）。値域 [-1, 1]、1=完全正相関、0=ランダム。 |
| クラスタ数 | 同一内部状態の連結成分数。4近傍で連結判定。 |

### 7.3 時間構造

| 指標 | 計算方法 |
|------|---------|
| 準周期性 | 状態系列の自己相関関数のピーク数。FFTで周波数成分を分析。 |
| 相転移 | 指標の時系列における急激な変化の検出。状態エントロピーの時系列微分の最大値。 |

### 7.4 役割分化

| 指標 | 計算方法 |
|------|---------|
| 行動エントロピー | 各エージェントの行動履歴のShannon entropy。全員が同じ行動分布なら役割分化なし。 |
| 行動偏り分散 | エージェント間の行動エントロピーの分散。大きければ役割が分化している。 |

### 7.5 情報伝播

| 指標 | 計算方法 |
|------|---------|
| 近傍相互情報量 | 隣接セル間の内部状態の相互情報量 I(S_i; S_j)。全隣接ペアの平均。 |

---

## 8. 実験スケール（段階的）

| フェーズ | ルール数 | 目的 |
|---------|---------|------|
| Phase 1: デバッグ | 100 | 実装の検証、バグ出し |
| Phase 2: 探索 | 1,000 | フィルタの動作確認、生存率の概算 |
| Phase 3: 本実験 | 10,000+ | 統計的に意味のある結果、複数seedで実行 |

各フェーズで複数seed（乱数シード）を使い、結果の分散を確認する。

---

## 9. データ保存

### 9.1 ルール保存（JSON）

```json
{
  "rule_id": "uuid",
  "table": [3, 0, 8, ...],
  "survived": true,
  "filter_results": {
    "halt": false,
    "state_uniform": false
  },
  "metadata": {
    "seed": 42,
    "steps": 200,
    "halt_window": 10
  }
}
```

### 9.2 シミュレーションログ（Parquet）

| カラム | 型 | 説明 |
|--------|-----|------|
| rule_id | string | ルールUUID |
| step | int | ステップ番号 |
| agent_id | int | エージェントID |
| x | int | X座標 |
| y | int | Y座標 |
| state | int | 内部状態 |
| action | int | 実行した行動 |

### 9.3 指標サマリ（Parquet）

| カラム | 型 | 説明 |
|--------|-----|------|
| rule_id | string | ルールUUID |
| step | int | ステップ番号 |
| state_entropy | float | 状態エントロピー |
| compression_ratio | float | 圧縮率 |
| morans_i | float | Moran's I |
| cluster_count | int | クラスタ数 |
| ... | ... | その他の指標 |

---

## 10. 可視化

- **技術**: matplotlib FuncAnimation
- **出力**: GIF / MP4
- **内容**:
  - 20×20グリッド上のエージェント配置
  - 内部状態を色で表現（4色）
  - ステップ数表示
  - 指標のリアルタイムプロット（サブプロット）
- **対象**: 生存ルールのシミュレーションを個別にアニメーション化

---

## 11. ファイル構成

```
objectless_alife/
├── src/
│   ├── __init__.py
│   ├── world.py          # World, Agent, Grid
│   ├── rules.py          # ルール生成・ルックアップテーブル
│   ├── metrics.py        # 観測指標の計算
│   ├── filters.py        # 破綻判定フィルタ
│   ├── run_search.py     # 探索パイプライン
│   └── visualize.py      # matplotlib可視化
├── tests/
│   ├── __init__.py
│   ├── test_world.py
│   ├── test_rules.py
│   ├── test_metrics.py
│   ├── test_filters.py
│   └── test_run_search.py
├── data/
│   ├── rules/            # 生存ルールJSON
│   └── logs/             # シミュレーションログParquet
├── output/               # アニメーション出力
├── pyproject.toml
└── README.md
```

---

## 12. 設計判断のまとめ

| 判断項目 | 決定 | 理由 |
|---------|------|------|
| フィルタ範囲 | 全停止＋状態単一化のみ | 「目的なし」を厳密に守る |
| 衝突 | 重なり禁止、移動失敗 | 空間的制約が複雑性の源になりうる |
| 観測 | 自身の状態＋近傍5セルの個体数 | テーブルサイズ128で管理可能 |
| 行動 | 排他的（9種） | シンプルで表現力のバランスが良い |
| 更新順序 | ランダム逐次 | 競合解決が自然 |
| 停止判定 | 連続Nステップ（Nはパラメータ） | 計算効率＋柔軟性 |
| 状態単一化 | 完全同一のみ | 閾値を使わず目的関数化を回避 |
| ステップ数 | 200（可変） | 感度分析で最適値を探る |
| データ形式 | JSON + Parquet | 柔軟性＋分析性能 |
| 可視化 | matplotlib | GIF/MP4出力、実装コスト低 |
